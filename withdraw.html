<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pul yechish - Crash So'm</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a12; color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 400px; }
        .header { display: flex; align-items: center; margin-bottom: 30px; }
        .back-btn { background: #16213e; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 14px; margin-right: 15px; }
        
        .balance-card { background: linear-gradient(135deg, #16213e 0%, #0f3460 100%); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 25px; border: 1px solid #4ecca3; }
        .balance-card h3 { margin: 0; opacity: 0.7; font-size: 14px; }
        .balance-card div { font-size: 28px; font-weight: bold; color: #4ecca3; margin-top: 5px; }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; opacity: 0.8; }
        select, input { width: 100%; padding: 12px; background: #16213e; border: 1px solid #333; border-radius: 10px; color: white; font-size: 16px; box-sizing: border-box; outline: none; }
        select:focus, input:focus { border-color: #f8b400; }

        .withdraw-btn { width: 100%; padding: 15px; background: #f8b400; color: #000; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .withdraw-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
        .hint { font-size: 12px; color: #e94560; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="crash.html" class="back-btn">‚Üê Orqaga</a>
        <h2 style="margin:0">Pul yechish</h2>
    </div>

    <div class="balance-card">
        <h3>Sizning balansingiz</h3>
        <div id="balanceDisplay">0 so'm</div>
    </div>

    <div class="input-group">
        <label>To'lov tizimi</label>
        <select id="cardType">
            <option value="Uzcard">Uzcard</option>
            <option value="Humo">Humo</option>
        </select>
    </div>

    <div class="input-group">
        <label>Karta raqami</label>
        <input type="number" id="cardNumber" placeholder="8600 . . . .">
    </div>

    <div class="input-group">
        <label>Summa (Min: 5,000)</label>
        <input type="number" id="amount" placeholder="5000">
    </div>

    <button class="withdraw-btn" id="submitBtn">Yuborish</button>
    <div class="hint" id="errorHint"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBt_YoPMKJlEL7RAGwWNx6uPJpoOHaQ2iY",
        authDomain: "game-49172.firebaseapp.com",
        databaseURL: "https://game-49172-default-rtdb.firebaseio.com",
        projectId: "game-49172",
        storageBucket: "game-49172.firebasestorage.app",
        messagingSenderId: "695585468530",
        appId: "1:695585468530:web:e0155f596c4778d1d412eb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user || { id: "test_user", username: "guest" };
    const userId = user.id.toString();

    let currentBalance = 0;

    onValue(ref(db, `users/${userId}`), (snap) => {
        if (snap.exists()) {
            currentBalance = snap.val().balance;
            document.getElementById('balanceDisplay').innerText = currentBalance.toLocaleString() + " so'm";
        }
    });

    document.getElementById('submitBtn').onclick = async () => {
        const type = document.getElementById('cardType').value;
        const number = document.getElementById('cardNumber').value;
        const amount = parseInt(document.getElementById('amount').value);
        const hint = document.getElementById('errorHint');

        if (number.length < 16) {
            hint.innerText = "Karta raqami xato!";
            return;
        }
        if (amount < 5000) {
            hint.innerText = "Minimal yechish 5,000 so'm!";
            return;
        }
        if (amount > currentBalance) {
            hint.innerText = "Mablag' yetarli emas!";
            return;
        }

        document.getElementById('submitBtn').disabled = true;
        
        // 1. Balansdan ayirish
        await update(ref(db, `users/${userId}`), { balance: currentBalance - amount });

        // 2. Admin uchun so'rov yuborish
        await push(ref(db, 'withdraw_requests'), {
            userId: userId,
            userName: user.username || user.first_name,
            cardType: type,
            cardNumber: number,
            amount: amount,
            status: 'pending',
            date: Date.now()
        });

        tg.showAlert("So'rov yuborildi! Admin tasdiqlashini kuting.");
        window.location.href = 'crash.html';
    };
</script>
</body>
</html>
